<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu CRM - Gestão de Clientes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (manter todos os estilos anteriores) ... */
    </style>
</head>
<body>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <!-- ... (manter todo o HTML anterior) ... -->
    </div>

    <!-- Modal Cliente -->
    <div class="modal" id="clientModal">
        <!-- ... (manter o modal anterior) ... -->
    </div>

    <!-- Input oculto para importação -->
    <input type="file" id="fileInput" accept=".csv" style="display: none;">

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCAZJIWT5FPTshkArRs8v2U9hXAmtnlG-Q",
            authDomain: "myname22.firebaseapp.com",
            databaseURL: "https://myname22-default-rtdb.firebaseio.com",
            projectId: "myname22",
            storageBucket: "myname22.appspot.com",
            messagingSenderId: "346543194739",
            appId: "1:346543194739:web:bcb8fa36574ca5de552006"
        };

        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const clientsRef = database.ref('clientes');

        // Variáveis globais
        let clientsData = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredData = [];
        let currentSort = { column: 'name', direction: 'asc' };
        let currentFilter = 'all';
        let editingClientId = null;
        let searchTimeout;

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadClients();
        });

        // Mostrar/ocultar loading
        function showLoading(show) {
            const loader = document.getElementById('loadingOverlay');
            if (loader) {
                loader.style.display = show ? 'flex' : 'none';
            }
        }

        // Mostrar notificação
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Carrega clientes do Firebase
        function loadClients() {
            showLoading(true);
            
            const connectionTimeout = setTimeout(() => {
                showNotification('Conexão demorando... usando cache local', 'warning');
                loadCachedData();
            }, 5000);

            clientsRef.on('value', (snapshot) => {
                clearTimeout(connectionTimeout);
                clientsData = [];
                const data = snapshot.val();
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        clientsData.push({
                            id: key,
                            name: data[key].name || '',
                            email: data[key].email || '',
                            phone: data[key].phone || '',
                            company: data[key].company || '',
                            serviceType: data[key].serviceType || 'Consultoria',
                            status: data[key].status || 'Realizando',
                            value: parseFloat(data[key].value) || 0,
                            notes: data[key].notes || '',
                            lastContact: data[key].lastContact || new Date().toISOString().split('T')[0]
                        });
                    });
                    
                    localStorage.setItem('crmCache', JSON.stringify(clientsData));
                    applyFiltersAndSorting();
                    renderClientsTable();
                    calculateTotalValue();
                    showLoading(false);
                } else {
                    showNotification('Nenhum cliente cadastrado ainda', 'info');
                    showNoResults();
                    showLoading(false);
                }
            }, (error) => {
                clearTimeout(connectionTimeout);
                console.error("Erro ao carregar clientes:", error);
                showNotification('Erro ao carregar clientes. Usando cache local.', 'error');
                loadCachedData();
            });
        }

        // Carrega dados do cache local
        function loadCachedData() {
            const cachedData = localStorage.getItem('crmCache');
            if (cachedData) {
                clientsData = JSON.parse(cachedData);
                applyFiltersAndSorting();
                renderClientsTable();
                calculateTotalValue();
            } else {
                showNoResults();
            }
            showLoading(false);
        }

        // Mostra mensagem de nenhum resultado
        function showNoResults() {
            document.getElementById('clientsTableBody').innerHTML = 
                '<tr><td colspan="7" class="no-results">Nenhum cliente encontrado</td></tr>';
            updatePaginationInfo();
        }

        // Renderiza a tabela de clientes
        function renderClientsTable() {
            const tableBody = document.getElementById('clientsTableBody');
            
            if (filteredData.length === 0) {
                showNoResults();
                return;
            }

            tableBody.innerHTML = '';
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedData = filteredData.slice(startIndex, endIndex);

            paginatedData.forEach(client => {
                const statusClass = client.status === 'Entregue' ? 'status-entregue' : 'status-realizando';
                const initials = getInitials(client.name);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="client-info">
                            <span class="client-initials" style="background-color: ${stringToColor(initials)}">${initials}</span>
                            <div>
                                <strong>${client.name}</strong>
                                <small>${client.email}</small>
                            </div>
                        </div>
                    </td>
                    <td>R$ ${client.value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>${formatPhone(client.phone)}</td>
                    <td>${client.company}</td>
                    <td><span class="service-badge">${client.serviceType}</span></td>
                    <td><span class="status-badge ${statusClass}">${client.status}</span></td>
                    <td class="actions-cell">
                        <button class="action-btn edit-btn" data-id="${client.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" data-id="${client.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            updatePaginationInfo();
        }

        // Formata número de telefone
        function formatPhone(phone) {
            if (!phone) return '';
            // Remove tudo que não é dígito
            const cleaned = phone.replace(/\D/g, '');
            
            // Formatação para números com 10 ou 11 dígitos
            if (cleaned.length === 11) {
                return cleaned.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (cleaned.length === 10) {
                return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
            }
            
            return phone;
        }

        // Aplica filtros e ordenação
        function applyFiltersAndSorting() {
            // Aplica filtro
            if (currentFilter !== 'all') {
                filteredData = clientsData.filter(client => client.status === currentFilter);
            } else {
                filteredData = [...clientsData];
            }

            // Aplica busca
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredData = filteredData.filter(client => 
                    (client.name && client.name.toLowerCase().includes(searchTerm)) || 
                    (client.email && client.email.toLowerCase().includes(searchTerm)) ||
                    (client.company && client.company.toLowerCase().includes(searchTerm)) ||
                    (client.phone && client.phone.includes(searchTerm)) ||
                    (client.serviceType && client.serviceType.toLowerCase().includes(searchTerm))
                );
            }

            // Aplica ordenação
            filteredData.sort((a, b) => {
                const valueA = a[currentSort.column];
                const valueB = b[currentSort.column];
                
                if (valueA < valueB) {
                    return currentSort.direction === 'asc' ? -1 : 1;
                }
                if (valueA > valueB) {
                    return currentSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });

            currentPage = 1;
        }

        // Atualiza os ícones de ordenação
        function updateSortIcons() {
            document.querySelectorAll('[data-sort]').forEach(icon => {
                icon.className = 'fas fa-sort';
                if (icon.getAttribute('data-sort') === currentSort.column) {
                    icon.classList.add(`fa-sort-${currentSort.direction}`);
                }
            });
        }

        // Atualiza as informações de paginação
        function updatePaginationInfo() {
            const showingFrom = document.getElementById('showingFrom');
            const showingTo = document.getElementById('showingTo');
            const totalClients = document.getElementById('totalClients');
            const pageNumbers = document.getElementById('pageNumbers');
            
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(startIndex + itemsPerPage - 1, filteredData.length);
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            showingFrom.textContent = startIndex;
            showingTo.textContent = endIndex;
            totalClients.textContent = filteredData.length;
            
            // Atualiza botões de paginação
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
            
            // Atualiza números das páginas
            pageNumbers.innerHTML = '';
            const maxPagesToShow = 3;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = `btn ${i === currentPage ? 'active' : ''}`;
                btn.textContent = i;
                btn.addEventListener('click', () => {
                    currentPage = i;
                    renderClientsTable();
                });
                pageNumbers.appendChild(btn);
            }
        }

        // Calcula o valor total de todos os clientes
        function calculateTotalValue() {
            const total = clientsData.reduce((sum, client) => sum + (parseFloat(client.value) || 0), 0);
            document.getElementById('totalValue').textContent = 
                `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        // Configura os event listeners
        function setupEventListeners() {
            // Botão Novo Cliente
            document.getElementById('newClientBtn').addEventListener('click', openClientModal);
            
            // Botão Fechar Modal
            document.querySelector('.close-modal').addEventListener('click', closeClientModal);
            
            // Botão Cancelar Modal
            document.querySelector('.cancel-btn').addEventListener('click', closeClientModal);
            
            // Submissão do Formulário
            document.getElementById('clientForm').addEventListener('submit', handleFormSubmit);
            
            // Paginação
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderClientsTable();
                }
            });
            
            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredData.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderClientsTable();
                }
            });
            
            // Filtros
            document.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    currentFilter = this.getAttribute('data-filter');
                    applyFiltersAndSorting();
                    renderClientsTable();
                });
            });
            
            // Ordenação
            document.querySelectorAll('[data-sort]').forEach(icon => {
                icon.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    
                    if (currentSort.column === column) {
                        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSort.column = column;
                        currentSort.direction = 'asc';
                    }
                    
                    applyFiltersAndSorting();
                    renderClientsTable();
                    updateSortIcons();
                });
            });
            
            // Busca com debounce
            document.getElementById('searchInput').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFiltersAndSorting();
                    renderClientsTable();
                }, 300);
            });
            
            // Delegation para botões de ação na tabela
            document.getElementById('clientsTableBody').addEventListener('click', function(e) {
                const target = e.target.closest('button');
                if (!target) return;
                
                const clientId = target.getAttribute('data-id');
                
                if (target.classList.contains('edit-btn')) {
                    editClient(clientId);
                } else if (target.classList.contains('delete-btn')) {
                    deleteClient(clientId);
                }
            });
            
            // Fechar modal ao clicar fora
            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('clientModal')) {
                    closeClientModal();
                }
            });

            // Botão Exportar
            document.getElementById('exportClientsBtn').addEventListener('click', exportClientsToCSV);
            
            // Botão Importar
            document.getElementById('importClientsBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            // Listener para o input de arquivo
            document.getElementById('fileInput').addEventListener('change', importClientsFromCSV);
        }

        // Exportar clientes para CSV
        function exportClientsToCSV() {
            showLoading(true);
            
            try {
                // Cabeçalhos do CSV
                const headers = ['Nome', 'Email', 'Telefone', 'Empresa', 'Tipo de Serviço', 'Status', 'Valor', 'Observações', 'Último Contato'];
                
                // Dados dos clientes
                const csvContent = [
                    headers.join(','),
                    ...filteredData.map(client => [
                        `"${client.name.replace(/"/g, '""')}"`,
                        `"${client.email.replace(/"/g, '""')}"`,
                        `"${client.phone.replace(/"/g, '""')}"`,
                        `"${client.company.replace(/"/g, '""')}"`,
                        `"${client.serviceType.replace(/"/g, '""')}"`,
                        `"${client.status.replace(/"/g, '""')}"`,
                        client.value,
                        `"${client.notes.replace(/"/g, '""')}"`,
                        `"${client.lastContact}"`
                    ].join(','))
                ].join('\n');
                
                // Criar blob e link para download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `clientes_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Clientes exportados com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar clientes:', error);
                showNotification('Erro ao exportar clientes', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Importar clientes de CSV
        function importClientsFromCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showLoading(true);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    
                    // Mapear colunas do CSV para os campos do cliente
                    const clientsToImport = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
                                            .map(v => v.trim().replace(/^"|"$/g, ''));
                        
                        const client = {
                            name: values[headers.indexOf('Nome')] || '',
                            email: values[headers.indexOf('Email')] || '',
                            phone: values[headers.indexOf('Telefone')] || '',
                            company: values[headers.indexOf('Empresa')] || '',
                            serviceType: values[headers.indexOf('Tipo de Serviço')] || 'Consultoria',
                            status: values[headers.indexOf('Status')] || 'Realizando',
                            value: parseFloat(values[headers.indexOf('Valor')]) || 0,
                            notes: values[headers.indexOf('Observações')] || '',
                            lastContact: values[headers.indexOf('Último Contato')] || new Date().toISOString().split('T')[0]
                        };
                        
                        clientsToImport.push(client);
                    }
                    
                    // Confirmar importação
                    if (confirm(`Deseja importar ${clientsToImport.length} clientes?`)) {
                        importClientsBatch(clientsToImport);
                    } else {
                        showLoading(false);
                    }
                } catch (error) {
                    console.error('Erro ao importar clientes:', error);
                    showNotification('Formato de arquivo inválido', 'error');
                    showLoading(false);
                }
            };
            reader.readAsText(file);
        }

        // Importar clientes em lotes (para evitar sobrecarga)
        function importClientsBatch(clients, index = 0, batchSize = 5) {
            if (index >= clients.length) {
                showNotification(`${clients.length} clientes importados com sucesso!`, 'success');
                showLoading(false);
                loadClients(); // Recarregar a lista
                return;
            }
            
            const batch = clients.slice(index, index + batchSize);
            const promises = batch.map(client => clientsRef.push(client));
            
            Promise.all(promises)
                .then(() => {
                    importClientsBatch(clients, index + batchSize, batchSize);
                })
                .catch(error => {
                    console.error('Erro ao importar lote:', error);
                    showNotification(`Erro ao importar clientes (${index + batch.length}/${clients.length})`, 'error');
                    showLoading(false);
                });
        }

        // Abre o modal de cliente
        function openClientModal() {
            editingClientId = null;
            document.getElementById('modalTitle').textContent = 'Novo Cliente';
            document.getElementById('clientForm').reset();
            document.getElementById('clientModal').style.display = 'flex';
        }

        // Fecha o modal
        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        // Manipula o envio do formulário
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const clientData = {
                name: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                company: document.getElementById('clientCompany').value,
                serviceType: document.getElementById('clientServiceType').value,
                status: document.getElementById('clientStatus').value,
                value: document.getElementById('clientValue').value,
                notes: document.getElementById('clientNotes').value,
                lastContact: new Date().toISOString().split('T')[0]
            };

            // Validação básica
            if (!clientData.name || !clientData.email || !clientData.phone || !clientData.serviceType || !clientData.status || !clientData.value) {
                showNotification('Preencha todos os campos obrigatórios', 'error');
                return;
            }

            showLoading(true);
            
            if (editingClientId) {
                // Atualiza cliente existente
                clientsRef.child(editingClientId).update(clientData)
                    .then(() => {
                        showNotification('Cliente atualizado com sucesso!', 'success');
                        closeClientModal();
                    })
                    .catch(error => {
                        console.error('Erro ao atualizar cliente:', error);
                        showNotification('Erro ao atualizar cliente', 'error');
                    })
                    .finally(() => showLoading(false));
            } else {
                // Adiciona novo cliente
                clientsRef.push(clientData)
                    .then(() => {
                        showNotification('Cliente adicionado com sucesso!', 'success');
                        closeClientModal();
                    })
                    .catch(error => {
                        console.error('Erro ao adicionar cliente:', error);
                        showNotification('Erro ao adicionar cliente', 'error');
                    })
                    .finally(() => showLoading(false));
            }
        }

        // Edita um cliente
        function editClient(clientId) {
            showLoading(true);
            
            clientsRef.child(clientId).once('value', (snapshot) => {
                const client = snapshot.val();
                if (!client) {
                    showNotification('Cliente não encontrado', 'error');
                    showLoading(false);
                    return;
                }
                
                editingClientId = clientId;
                document.getElementById('modalTitle').textContent = 'Editar Cliente';
                document.getElementById('clientId').value = clientId;
                document.getElementById('clientName').value = client.name || '';
                document.getElementById('clientEmail').value = client.email || '';
                document.getElementById('clientPhone').value = client.phone || '';
                document.getElementById('clientCompany').value = client.company || '';
                document.getElementById('clientServiceType').value = client.serviceType || 'Consultoria';
                document.getElementById('clientStatus').value = client.status || 'Realizando';
                document.getElementById('clientValue').value = client.value || '';
                document.getElementById('clientNotes').value = client.notes || '';
                
                document.getElementById('clientModal').style.display = 'flex';
                showLoading(false);
            }, (error) => {
                console.error('Erro ao carregar cliente:', error);
                showNotification('Erro ao carregar dados do cliente', 'error');
                showLoading(false);
            });
        }

        // Exclui um cliente
        function deleteClient(clientId) {
            if (confirm('Tem certeza que deseja excluir este cliente?')) {
                showLoading(true);
                
                clientsRef.child(clientId).remove()
                    .then(() => {
                        showNotification('Cliente excluído com sucesso!', 'success');
                    })
                    .catch(error => {
                        console.error('Erro ao excluir cliente:', error);
                        showNotification('Erro ao excluir cliente', 'error');
                    })
                    .finally(() => showLoading(false));
            }
        }

        // Gera iniciais a partir do nome
        function getInitials(name) {
            if (!name) return '';
            return name.split(' ')
                .filter(part => part.length > 0)
                .map(part => part[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);
        }

        // Gera cor a partir de uma string (para as iniciais)
        function stringToColor(str) {
            if (!str) return '#cccccc';
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            const h = hash % 360;
            return `hsl(${h}, 70%, 60%)`;
        }
    </script>
</body>
</html>
